<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Logger</title>    <style>        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        /* Main container for responsive layout */
        .main-container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
        }
        
        /* Controls and input section */
        .controls-section {
            flex-shrink: 0;
        }
        
        /* Logs display section */
        .logs-section {
            flex: 1;
            min-height: 300px;
        }
          /* Landscape mode (aspect ratio based detection) */
        @media screen and (min-aspect-ratio: 4/3) and (min-width: 768px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
            }
            
            .controls-section {
                width: min(350px, 30vw);
                flex-shrink: 0;
                position: sticky;
                top: 20px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }
            
            .logs-section {
                flex: 1;
                min-width: 0; /* Important for flex child */
            }
            
            /* Make controls more compact in landscape */
            .controls button {
                font-size: 0.9em;
                padding: 6px 12px;
            }
            
            .inputContainer {
                margin-bottom: 15px;
            }
            
            #logTitle, #logInput {
                font-size: 0.9em;
            }
        }
        
        /* Portrait mode - stack vertically */
        @media screen and (max-aspect-ratio: 4/3), screen and (max-width: 767px) {
            .main-container {
                flex-direction: column;
            }
            
            .controls-section {
                width: 100%;
            }
            
            .logs-section {
                width: 100%;
            }
        }.inputContainer { margin-bottom: 20px; }
        #logTitle { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        #logTitle:focus { border-color: #007acc; outline: none; }
        #logInput { width: 100%; padding: 10px; margin-bottom: 10px; resize: vertical; min-height: 80px; box-sizing: border-box; }
        .controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .controls button { padding: 8px 16px; white-space: nowrap; }
        .logEntry { 
            border: 1px solid #ccc; 
            margin: 5px 0; 
            padding: 10px; 
            border-radius: 5px; 
            background: #f9f9f9; 
        }        .logHeader { 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background-color 0.2s ease;
        }
        .logHeader:hover { 
            background: #f0f0f0; 
        }
        .logTitle { font-weight: bold; color: #333; }
        .logEntryTitle { 
            font-weight: bold; 
            color: #2c5aa0; 
            margin-right: 10px;
        }        .logTimestamp { 
            color: #000; 
            font-size: 0.9em; 
            font-weight: bold;
        }
        .logSeparator {
            color: #666;
            margin: 0 8px;
            font-weight: normal;
        }        .logNumber { 
            color: #007acc; 
            font-weight: bold; 
            margin-right: 10px; 
            font-family: 'Courier New', monospace;
            cursor: help;
            position: relative;
        }
        .logNumber:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            animation: fadeInTooltip 0.3s forwards;
        }
        .logNumber:hover::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #333;
            z-index: 1000;
            opacity: 0;
            animation: fadeInTooltip 0.3s forwards;
        }
        @keyframes fadeInTooltip {
            to { opacity: 1; }
        }
        .logPreview { 
            color: #666; 
            font-style: italic; 
            margin-left: 10px; 
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            flex: 1; 
        }        .logMeta { display: flex; align-items: center; gap: 10px; }
        .logTimestamp { color: #888; font-size: 0.9em; }
        .logEntry button { margin-left: 10px; padding: 4px 8px; }
        .copyBtn { 
            background: #007acc; 
            color: white; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 0.8em;
        }
        .copyBtn:hover { background: #005a99; }
        .deleteBtn { 
            background: #dc3545; 
            color: white; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer; 
        }
        .deleteBtn:hover { background: #c82333; }        .logContent { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .expanded .logContent { display: block; }        .toggleIcon { 
            transition: transform 0.2s ease; 
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            user-select: none;
        }
        .toggleIcon:hover {
            background: rgba(0, 122, 204, 0.1);
        }
        .expanded .toggleIcon { 
            transform: rotate(180deg); 
        }
        
        /* Go to Top Button */
        .goToTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .goToTopBtn:hover {
            background: #005a99;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .goToTopBtn.show {
            display: block;
        }
          /* Search Bar */
        .searchContainer {
            margin-bottom: 15px;
            position: relative;
        }
        .searchInput {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        .searchInput:focus {
            border-color: #007acc;
        }
        .searchIcon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 16px;
            pointer-events: none;
        }
        .clearSearchBtn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }
        .clearSearchBtn:hover {
            color: #666;
        }
        .searchResults {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }
        .logEntry.hidden {
            display: none;
        }        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .sortBtn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }
        .sortBtn:hover {
            background: #218838;
        }        .sortBtn.active {
            background: #17a2b8;
        }
        .fileStatus {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
            font-style: italic;
        }
        .fileStatus.success {
            color: #28a745;
        }
        .fileStatus.error {
            color: #dc3545;
        }        .fileControls {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .fileControls button {
            margin-right: 10px;
            margin-bottom: 5px;
            padding: 6px 12px;
            font-size: 0.9em;
        }
        .autoSaveBtn {
            background: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .autoSaveBtn:hover {
            background: #5a32a3;
        }
        .autoSaveBtn.active {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="controls-section">
            <h1>Smart Logger</h1>

            <div class="fileControls">
                <button id="enableAutoSaveBtn" class="autoSaveBtn" onclick="toggleAutoSave()">üìÅ Enable Auto-Save to File</button>
                <button onclick="loadFromFile()">üìÇ Load from File</button>
                <button onclick="saveToFile()">üíæ Save to File Now</button>
                <span id="fileStatus" class="fileStatus">Auto-save: Disabled (using localStorage only)</span>
            </div>

            <div class="controls">
                <button onclick="exportLogs()">üì§ Export Logs</button>
                <button onclick="importLogs()">üì• Import Logs</button>
                <button onclick="clearAllLogs()">üóëÔ∏è Clear All</button>
                <button onclick="expandAll()">üìÇ Expand All</button>
                <button onclick="collapseAll()">üìÅ Collapse All</button>
                <button id="sortBtn" class="sortBtn" onclick="toggleSort()">üî¢ Sort: Oldest First</button>
            </div>            <div class="searchContainer">
                <span class="searchIcon">üîç</span>
                <input type="text" id="searchInput" class="searchInput" placeholder="Search logs..." oninput="searchLogs()" />
                <button class="clearSearchBtn" id="clearSearchBtn" onclick="clearSearch()" title="Clear search">‚úï</button>
            </div>
            
            <div id="searchResults" class="searchResults"></div>
    
            <div class="inputContainer">
                <input type="text" id="logTitle" placeholder="Enter log title (optional)..." readonly>
                <textarea id="logInput" placeholder="Enter your log content here... (Ctrl+Enter to add)" readonly></textarea>
                <button onclick="addLog()">Add Log</button>
            </div>
        </div>

        <div class="logs-section">
            <div id="logContainer"></div>
        </div>
    </div>

    <!-- Go to Top Button -->
    <button class="goToTopBtn" id="goToTopBtn" onclick="goToTop()" title="Go to top">‚Üë</button>    <script>
        const logContainer = document.getElementById('logContainer');        let allLogs = []; // Keep track of all logs for search
        let currentSearchTerm = '';
        let nextLogId = 1; // Counter for unique log IDs
        let isDescendingSort = false; // Track sort order
        
        // File system persistence variables
        let autoSaveEnabled = false;
        let fileHandle = null;
        let isFileAPISupported = 'showSaveFilePicker' in window;// Load logs from local storage
        const logs = JSON.parse(localStorage.getItem('logs')) || [];
        
        // Load or initialize the next log ID
        nextLogId = parseInt(localStorage.getItem('nextLogId')) || 1;
        
        // Migration: Add IDs and split title/content for existing logs
        let needsMigration = false;
        logs.forEach((log, index) => {
            if (!log.id) {
                log.id = nextLogId++;
                needsMigration = true;
            }
            
            // Migration: Split existing logs into title and content
            if (!log.hasOwnProperty('title')) {
                const lines = log.text.split('\n');
                log.title = lines[0] || ''; // First line as title
                log.content = lines.slice(1).join('\n').trim(); // Rest as content
                // If there was only one line, keep it as content too
                if (lines.length === 1) {
                    log.content = log.text;
                }
                needsMigration = true;
            }
            
            allLogs.push(log);
            displayLog(log);
        });
          // Save migrated data if needed
        if (needsMigration) {
            localStorage.setItem('logs', JSON.stringify(logs));
            localStorage.setItem('nextLogId', nextLogId.toString());
        }

        // Initialize file system features
        initializeFileSystem();// Add keyboard shortcut for Ctrl+Enter
        document.getElementById('logInput').addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                addLog();
            }
        });
        
        // Add keyboard shortcut for Ctrl+Enter on title field too
        document.getElementById('logTitle').addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                addLog();
            }
        });

        // Go to Top button functionality
        window.addEventListener('scroll', function() {
            const goToTopBtn = document.getElementById('goToTopBtn');
            if (window.pageYOffset > 300) {
                goToTopBtn.classList.add('show');
            } else {
                goToTopBtn.classList.remove('show');
            }
        });        function addLog() {
            const logTitle = document.getElementById('logTitle').value.trim();
            const logContent = document.getElementById('logInput').value.trim();
            
            // Validation: At least title OR content must be provided
            if (logTitle === '' && logContent === '') {
                alert('Please enter either a title or content for the log entry.');
                return;
            }

            const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
            const log = { 
                id: nextLogId++, 
                title: logTitle,
                content: logContent,
                timestamp 
            };
              logs.push(log);
            allLogs.push(log);
            localStorage.setItem('logs', JSON.stringify(logs));
            localStorage.setItem('nextLogId', nextLogId.toString());
            
            // Auto-save to file if enabled
            if (autoSaveEnabled) {
                autoSaveToFile();
            }
            
            // Add to display based on current sort order
            if (isDescendingSort) {
                // For descending, add at the beginning
                logContainer.insertBefore(createLogElement(log), logContainer.firstChild);
            } else {
                // For ascending, add at the end
                displayLog(log);
            }
            
            // Clear input fields
            document.getElementById('logTitle').value = '';
            document.getElementById('logInput').value = '';
            
            // Update search results if search is active
            if (currentSearchTerm) {
                searchLogs();
            }
        }function displayLog(log) {
            const logElement = createLogElement(log);
            logContainer.appendChild(logElement);
        }        function createLogElement(log) {
            const logEntry = document.createElement('div');
            logEntry.className = 'logEntry';
            
            // Calculate display position (1-based)
            const allVisibleLogs = allLogs.filter(l => logs.includes(l));
            const logPosition = allVisibleLogs.findIndex(l => l.id === log.id) + 1;
            const totalLogs = allVisibleLogs.length;
            
            // Determine what to show in preview
            let previewText = '';
            if (log.title) {
                previewText = log.title.length > 60 ? log.title.substring(0, 60) + '...' : log.title;
            } else if (log.content) {
                const firstLine = log.content.split('\n')[0];
                previewText = firstLine.length > 60 ? firstLine.substring(0, 60) + '...' : firstLine;
            }
            
            // Determine what to show in expanded content
            let fullContent = '';
            if (log.title && log.content) {
                fullContent = `<strong>${log.title}</strong><br><br>${log.content.replace(/\n/g, '<br>')}`;
            } else if (log.title) {
                fullContent = `<strong>${log.title}</strong>`;
            } else {
                fullContent = log.content.replace(/\n/g, '<br>');
            }            logEntry.innerHTML = `
                <div class="logHeader" onclick="toggleLog(this)">
                    <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                        <span class="logNumber" data-tooltip="Log ${logPosition} of ${totalLogs}">#${log.id}</span>
                        <span class="logTimestamp">${log.timestamp}</span>
                        ${log.title ? `<span class="logSeparator">|</span><span class="logEntryTitle">${log.title}</span>` : ''}
                        ${!log.title && previewText ? `<span class="logSeparator">|</span><span class="logPreview">${previewText}</span>` : ''}
                    </div>
                    <div class="logMeta">
                        <span class="toggleIcon" onmouseenter="startToggleHover(this)" onmouseleave="clearToggleHover(this)" title="Hover to auto-expand/collapse">‚ñº</span>
                        <button class="copyBtn" onclick="event.stopPropagation(); copyLog(this)" title="Copy log content">üìã Copy</button>
                        <button class="deleteBtn" onclick="event.stopPropagation(); deleteLog(this)" title="Delete log">Delete</button>
                    </div>
                </div>
                <div class="logContent">${fullContent}</div>
            `;
            return logEntry;
        }        function toggleLog(logHeader) {
            const logEntry = logHeader.parentElement;
            logEntry.classList.toggle('expanded');
        }        // Hover timer functionality
        let toggleHoverTimer = null;
        const HOVER_DELAY = 800; // 800ms delay

        function startToggleHover(toggleIcon) {
            clearToggleHover();
            const logHeader = toggleIcon.closest('.logHeader');
            toggleHoverTimer = setTimeout(() => {
                toggleLog(logHeader);
            }, HOVER_DELAY);
        }

        function clearToggleHover() {
            if (toggleHoverTimer) {
                clearTimeout(toggleHoverTimer);
                toggleHoverTimer = null;
            }
        }function deleteLog(deleteButton) {
            if (!confirm('Are you sure you want to delete this log?')) return;
              const logEntry = deleteButton.closest('.logEntry');
            
            // Get the log ID from the displayed number
            const logNumberElement = logEntry.querySelector('.logNumber');
            const logId = parseInt(logNumberElement.textContent.replace('#', ''));
            
            console.log('Deleting log with ID:', logId);
            
            // Find the log by ID in our arrays
            const logIndex = logs.findIndex(log => log.id === logId);
            const allLogIndex = allLogs.findIndex(log => log.id === logId);
            
            console.log('Found log at indices:', { logIndex, allLogIndex });
            
            if (logIndex === -1 || allLogIndex === -1) {
                alert('Error: Could not find log to delete');
                return;
            }
            
            // Remove from display
            logContainer.removeChild(logEntry);
              // Remove from data arrays
            logs.splice(logIndex, 1);
            allLogs.splice(allLogIndex, 1);
            
            console.log('After deletion:', { logsCount: logs.length, allLogsCount: allLogs.length });
            
            // Optional: Reorder IDs (uncomment if you want this behavior)
            // WARNING: This breaks data integrity with exports/imports
            // reorderLogIds(logId);
            
            // Save to localStorage
            localStorage.setItem('logs', JSON.stringify(logs));
            
            // Auto-save to file if enabled
            if (autoSaveEnabled) {
                console.log('Triggering auto-save after deletion');
                autoSaveToFile();
            } else {
                console.log('Auto-save not enabled');
            }
            
            // Update search results if search is active
            if (currentSearchTerm) {
                searchLogs();
            }
        }        function copyLog(copyButton) {
            const logEntry = copyButton.closest('.logEntry');
            
            // Get the log ID from the displayed number
            const logNumberElement = logEntry.querySelector('.logNumber');
            const logId = parseInt(logNumberElement.textContent.replace('#', ''));
            
            // Find the log by ID in our arrays
            const log = allLogs.find(log => log.id === logId);
            
            if (!log) {
                alert('Error: Could not find log to copy');
                return;
            }
            
            // Determine what to copy based on available content
            let textToCopy = '';
            if (log.title && log.content) {
                textToCopy = `${log.title}\n\n${log.content}`;
            } else if (log.title) {
                textToCopy = log.title;
            } else {
                textToCopy = log.content;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Visual feedback
                const originalText = copyButton.textContent;
                copyButton.textContent = '‚úì Copied!';
                copyButton.style.background = '#28a745';
                
                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.style.background = '#007acc';
                }, 1500);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Visual feedback
                const originalText = copyButton.textContent;
                copyButton.textContent = '‚úì Copied!';
                copyButton.style.background = '#28a745';
                
                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.style.background = '#007acc';
                }, 1500);
            });
        }

        function exportLogs() {
            if (logs.length === 0) {
                alert('No logs to export!');
                return;
            }
            
            const exportData = {
                logs: logs,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `logger-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Logs exported successfully!');
        }

        function importLogs() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.logs && Array.isArray(data.logs)) {
                            const action = logs.length > 0 ? 
                                confirm('Do you want to replace existing logs?\nClick OK to replace, Cancel to merge.') :
                                true;
                            

                            if (action) {
                                // Replace existing logs
                                logs.length = 0;
                                logContainer.innerHTML = '';
                            }                            // Add imported logs
                            data.logs.forEach(log => {
                                // Assign ID if not present
                                if (!log.id) {
                                    log.id = nextLogId++;
                                }
                                
                                // Migration for imported logs without title/content structure
                                if (!log.hasOwnProperty('title') && log.text) {
                                    const lines = log.text.split('\n');
                                    log.title = lines[0] || '';
                                    log.content = lines.slice(1).join('\n').trim();
                                    if (lines.length === 1) {
                                        log.content = log.text;
                                    }
                                }
                                
                                logs.push(log);
                                allLogs.push(log);
                                displayLog(log);
                            });
                              localStorage.setItem('nextLogId', nextLogId.toString());
                              localStorage.setItem('logs', JSON.stringify(logs));
                            alert(`${data.logs.length} logs imported successfully!`);
                            

                            // Auto-save to file if enabled
                            if (autoSaveEnabled) {
                                autoSaveToFile();
                            }
                            
                            // Update search results if search is active
                            if (currentSearchTerm) {
                                searchLogs();
                            }
                        } else {
                            alert('Invalid file format! Please select a valid logger backup file.');
                        }
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }        function clearAllLogs() {
            if (logs.length === 0) {
                alert('No logs to clear!');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete all ${logs.length} logs?\n\n‚úÖ An automatic backup will be exported before clearing\n‚ùå This action cannot be undone after clearing`;
            
            if (confirm(confirmMessage)) {
                // Auto-export before clearing
                try {
                    const exportData = {
                        logs: logs,
                        exportDate: new Date().toISOString(),
                        version: '1.0',
                        exportReason: 'Auto-backup before clear all'
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `logger-backup-before-clear-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Small delay to ensure download starts before clearing
                    setTimeout(() => {
                        logs.length = 0;
                        allLogs.length = 0;
                        nextLogId = 1; // Reset ID counter
                        logContainer.innerHTML = '';                        localStorage.setItem('logs', JSON.stringify(logs));
                        localStorage.setItem('nextLogId', '1');
                        
                        // Clear search if active
                        if (currentSearchTerm) {
                            clearSearch();
                        }
                        
                        // Auto-save to file if enabled (empty file)
                        if (autoSaveEnabled) {
                            autoSaveToFile();
                        }
                        
                        alert(`‚úÖ Backup exported successfully!\nüóëÔ∏è All logs cleared!\n\nüìÅ Look for the downloaded backup file to restore if needed.`);
                    }, 500);
                    
                } catch (error) {
                    alert('‚ùå Failed to create backup export. Clear operation cancelled for safety.');
                    console.error('Export error:', error);
                }
            }
        }function expandAll() {
            const logEntries = document.querySelectorAll('.logEntry:not(.hidden)'); // Only visible entries
            logEntries.forEach(entry => {
                if (!entry.classList.contains('expanded')) {
                    entry.classList.add('expanded');
                    const icon = entry.querySelector('.toggleIcon');
                    if (icon) icon.textContent = '‚ñ≤';
                }
            });
        }        function collapseAll() {
            const logEntries = document.querySelectorAll('.logEntry:not(.hidden)'); // Only visible entries
            logEntries.forEach(entry => {
                if (entry.classList.contains('expanded')) {
                    entry.classList.remove('expanded');
                    const icon = entry.querySelector('.toggleIcon');
                    if (icon) icon.textContent = '‚ñº';
                }
            });
        }

        // Go to Top function
        function goToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Search functionality
        function searchLogs() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const clearBtn = document.getElementById('clearSearchBtn');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            currentSearchTerm = searchTerm;
            
            // Show/hide clear button
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                searchResults.textContent = '';
                showAllLogs();
                return;
            }
            
            const logEntries = document.querySelectorAll('.logEntry');
            let matchCount = 0;
              logEntries.forEach((entry, index) => {
                const log = allLogs[index];
                
                // Search in title, content, and timestamp
                const titleText = (log.title || '').toLowerCase();
                const contentText = (log.content || '').toLowerCase();
                const timestamp = log.timestamp.toLowerCase();
                
                if (titleText.includes(searchTerm) || contentText.includes(searchTerm) || timestamp.includes(searchTerm)) {
                    entry.classList.remove('hidden');
                    highlightSearchTerm(entry, searchTerm);
                    matchCount++;
                } else {
                    entry.classList.add('hidden');
                }
            });
            
            // Update search results text
            if (matchCount === 0) {
                searchResults.textContent = `No logs found for "${searchInput.value}"`;
            } else {
                searchResults.textContent = `Found ${matchCount} log${matchCount === 1 ? '' : 's'} matching "${searchInput.value}"`;
            }
        }        function highlightSearchTerm(logEntry, searchTerm) {
            const logContent = logEntry.querySelector('.logContent');
            const logPreview = logEntry.querySelector('.logPreview');
            const logEntryTitle = logEntry.querySelector('.logEntryTitle');
            const timestamp = logEntry.querySelector('.logTimestamp');
            
            // Remove existing highlights
            [logContent, logPreview, logEntryTitle, timestamp].forEach(el => {
                if (el) {
                    el.innerHTML = el.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/gi, '$1');
                }
            });
            
            // Add new highlights
            if (searchTerm.length > 0) {
                [logContent, logPreview, logEntryTitle, timestamp].forEach(el => {
                    if (el) {
                        const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
                        el.innerHTML = el.innerHTML.replace(regex, '<span class="highlight">$1</span>');
                    }
                });
            }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            searchInput.value = '';
            currentSearchTerm = '';
            clearBtn.style.display = 'none';
            searchResults.textContent = '';
            showAllLogs();
            searchInput.focus();
        }        function showAllLogs() {
            const logEntries = document.querySelectorAll('.logEntry');
            logEntries.forEach(entry => {
                entry.classList.remove('hidden');
                // Remove highlights
                const elements = entry.querySelectorAll('.logContent, .logPreview, .logEntryTitle, .logTimestamp');
                elements.forEach(el => {
                    el.innerHTML = el.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/gi, '$1');
                });
            });
        }

        // Sorting functionality
        function toggleSort() {
            isDescendingSort = !isDescendingSort;
            const sortBtn = document.getElementById('sortBtn');
            
            if (isDescendingSort) {
                sortBtn.textContent = 'üî¢ Sort: Newest First';
                sortBtn.classList.add('active');
            } else {
                sortBtn.textContent = 'üî¢ Sort: Oldest First';
                sortBtn.classList.remove('active');
            }
            
            refreshDisplay();
        }

        function refreshDisplay() {
            // Store current expanded states
            const expandedStates = new Map();
            const logEntries = document.querySelectorAll('.logEntry');
            logEntries.forEach((entry, index) => {
                const logNumber = entry.querySelector('.logNumber').textContent;
                expandedStates.set(logNumber, entry.classList.contains('expanded'));
            });
            
            // Clear container
            logContainer.innerHTML = '';
            
            // Sort logs based on current sort order
            const sortedLogs = [...allLogs].sort((a, b) => {
                return isDescendingSort ? b.id - a.id : a.id - b.id;
            });
            
            // Re-display all logs in sorted order
            sortedLogs.forEach(log => {
                const logElement = createLogElement(log);
                
                // Restore expanded state
                const logNumber = `#${log.id}`;
                if (expandedStates.get(logNumber)) {
                    logElement.classList.add('expanded');
                    const icon = logElement.querySelector('.toggleIcon');
                    if (icon) icon.textContent = '‚ñ≤';
                }
                
                logContainer.appendChild(logElement);
            });            // Reapply search if active
            if (currentSearchTerm) {
                searchLogs();
            }
        }

        // Optional ID Reordering Function (USE WITH CAUTION)
        function reorderLogIds(deletedId) {
            console.log('Reordering IDs after deletion of:', deletedId);
            
            // Renumber all logs with IDs higher than deleted ID
            logs.forEach(log => {
                if (log.id > deletedId) {
                    log.id = log.id - 1;
                }
            });
            
            allLogs.forEach(log => {
                if (log.id > deletedId) {
                    log.id = log.id - 1;
                }
            });
            
            // Decrease nextLogId
            nextLogId = nextLogId - 1;
            
            console.log('After reordering:', { nextLogId, maxId: Math.max(...logs.map(l => l.id)) });
            
            // Refresh entire display to show new numbers
            refreshDisplay();
        }

        // File System Persistence Functions
        function initializeFileSystem() {
            const fileStatus = document.getElementById('fileStatus');
            const autoSaveBtn = document.getElementById('enableAutoSaveBtn');
            
            if (!isFileAPISupported) {
                fileStatus.textContent = 'File API not supported in this browser (localStorage only)';
                fileStatus.className = 'fileStatus error';
                autoSaveBtn.disabled = true;
                autoSaveBtn.textContent = 'üìÅ File API Not Supported';
                return;
            }
            
            // Try to load auto-save preference
            const savedAutoSave = localStorage.getItem('autoSaveEnabled') === 'true';
            if (savedAutoSave) {
                enableAutoSave(false); // Don't show prompt on startup
            }
        }

        function toggleAutoSave() {
            if (autoSaveEnabled) {
                disableAutoSave();
            } else {
                enableAutoSave(true);
            }
        }

        async function enableAutoSave(showPrompt = true) {
            if (!isFileAPISupported) {
                alert('File System Access API is not supported in this browser. Please use Chrome or Edge.');
                return;
            }

            try {
                if (showPrompt) {
                    // Ask user to select/create a file for auto-saving
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: 'logger-data.json',
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                }

                autoSaveEnabled = true;
                localStorage.setItem('autoSaveEnabled', 'true');
                
                const autoSaveBtn = document.getElementById('enableAutoSaveBtn');
                const fileStatus = document.getElementById('fileStatus');
                
                autoSaveBtn.textContent = '‚úÖ Auto-Save Enabled';
                autoSaveBtn.classList.add('active');
                fileStatus.textContent = 'Auto-save: Enabled - changes saved to file automatically';
                fileStatus.className = 'fileStatus success';
                
                // Immediately save current data
                if (fileHandle) {
                    await autoSaveToFile();
                }
                
            } catch (error) {
                console.error('Failed to enable auto-save:', error);
                if (error.name !== 'AbortError') {
                    alert('Failed to enable auto-save: ' + error.message);
                }
            }
        }

        function disableAutoSave() {
            autoSaveEnabled = false;
            fileHandle = null;
            localStorage.setItem('autoSaveEnabled', 'false');
            
            const autoSaveBtn = document.getElementById('enableAutoSaveBtn');
            const fileStatus = document.getElementById('fileStatus');
            
            autoSaveBtn.textContent = 'üìÅ Enable Auto-Save to File';
            autoSaveBtn.classList.remove('active');
            fileStatus.textContent = 'Auto-save: Disabled (using localStorage only)';
            fileStatus.className = 'fileStatus';
        }        async function autoSaveToFile() {
            if (!autoSaveEnabled || !fileHandle) {
                console.log('Auto-save skipped: not enabled or no file handle');
                return;
            }
            
            try {
                console.log('Auto-saving to file...', { logsCount: logs.length, nextLogId });
                
                const writable = await fileHandle.createWritable();
                const data = {
                    logs: logs,
                    nextLogId: nextLogId,
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    exportReason: 'Auto-save'
                };
                
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                
                console.log('Auto-save completed successfully');
                updateFileStatus('‚úÖ Auto-saved', 'success');
                
            } catch (error) {
                console.error('Auto-save failed:', error);
                updateFileStatus('‚ùå Auto-save failed', 'error');
                
                // Disable auto-save if file is no longer accessible
                if (error.name === 'NotAllowedError' || error.name === 'NotFoundError') {
                    disableAutoSave();
                    alert('Auto-save disabled: File is no longer accessible. Please re-enable if needed.');
                }
            }
        }

        async function saveToFile() {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: `logger-manual-save-${new Date().toISOString().split('T')[0]}.json`,
                    types: [{
                        description: 'JSON files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                const writable = await fileHandle.createWritable();
                const data = {
                    logs: logs,
                    nextLogId: nextLogId,
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    exportReason: 'Manual save'
                };
                
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                
                alert('‚úÖ Data saved to file successfully!');
                updateFileStatus('‚úÖ Manually saved', 'success');
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('‚ùå Failed to save file: ' + error.message);
                    console.error('Save failed:', error);
                }
            }
        }

        async function loadFromFile() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'JSON files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                const file = await fileHandle.getFile();
                const contents = await file.text();
                const data = JSON.parse(contents);
                
                if (data.logs && Array.isArray(data.logs)) {
                    const action = logs.length > 0 ? 
                        confirm('Do you want to replace existing logs?\nClick OK to replace, Cancel to merge.') :
                        true;
                    
                    if (action) {
                        // Replace existing logs
                        logs.length = 0;
                        allLogs.length = 0;
                        logContainer.innerHTML = '';
                    }
                    
                    // Update nextLogId if available in file
                    if (data.nextLogId) {
                        nextLogId = data.nextLogId;
                    }
                    
                    // Add loaded logs
                    data.logs.forEach(log => {
                        // Migration for old format logs
                        if (!log.hasOwnProperty('title') && log.text) {
                            const lines = log.text.split('\n');
                            log.title = lines[0] || '';
                            log.content = lines.slice(1).join('\n').trim();
                            if (lines.length === 1) {
                                log.content = log.text;
                            }
                        }
                        
                        logs.push(log);
                        allLogs.push(log);
                        displayLog(log);
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('logs', JSON.stringify(logs));
                    localStorage.setItem('nextLogId', nextLogId.toString());
                    
                    // Auto-save if enabled
                    if (autoSaveEnabled) {
                        autoSaveToFile();
                    }
                    
                    alert(`‚úÖ ${data.logs.length} logs loaded from file successfully!`);
                    updateFileStatus('‚úÖ Loaded from file', 'success');
                    
                } else {
                    alert('‚ùå Invalid file format! Please select a valid logger file.');
                }
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('‚ùå Failed to load file: ' + error.message);
                    console.error('Load failed:', error);
                }
            }
        }

        function updateFileStatus(message, type = '') {
            const fileStatus = document.getElementById('fileStatus');
            const originalMessage = fileStatus.textContent;
            
            fileStatus.textContent = message;
            fileStatus.className = `fileStatus ${type}`;
            
            // Revert to original message after 3 seconds
            setTimeout(() => {
                if (autoSaveEnabled) {
                    fileStatus.textContent = 'Auto-save: Enabled - changes saved to file automatically';
                    fileStatus.className = 'fileStatus success';
                } else {
                    fileStatus.textContent = 'Auto-save: Disabled (using localStorage only)';
                    fileStatus.className = 'fileStatus';
                }
            }, 3000);
        }

        // Generic harmonized activation for input fields
function harmonizeInputActivation(el, options = {}) {
    // Remove readonly and focus on mouseenter
    el.addEventListener('mouseenter', () => {
        el.removeAttribute('readonly');
        if (document.activeElement !== el) el.focus();
    });
    // Set readonly if not focused on mouseleave
    el.addEventListener('mouseleave', () => {
        if (document.activeElement !== el) el.setAttribute('readonly', true);
    });
    // Remove readonly on focus
    el.addEventListener('focus', () => el.removeAttribute('readonly'));
    // Set readonly on blur
    el.addEventListener('blur', () => el.setAttribute('readonly', true));
    // Custom keydown logic
    if (options.onEnter) {
        el.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                options.onEnter();
            }
        });
    }
    if (options.onShiftTab) {
        el.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                options.onShiftTab();
            }
        });
    }
}

(function() {
    const logTitle = document.getElementById('logTitle');
    const logInput = document.getElementById('logInput');
    const searchInput = document.getElementById('searchInput');

    harmonizeInputActivation(logTitle, {
        onEnter: () => logInput && (logInput.removeAttribute('readonly'), logInput.focus())
    });
    harmonizeInputActivation(logInput, {
        onShiftTab: () => logTitle && (logTitle.removeAttribute('readonly'), logTitle.focus())
    });
    harmonizeInputActivation(searchInput);
})();
    </script>
</body>
</html>
